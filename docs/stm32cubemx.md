# Use devicetree generated by STM32CubeMX

The [STM32CubeMX tool](https://www.st.com/en/development-tools/stm32cubemx.html "STM32CubeMX tool")
allows you to automatize the generation of devicetrees with an easy to use
interface. You can configure the state of each pin of the stm32mp1 component
from the pinout view. The tool generates devicetree for Linux, U-Boot and
Arm-Trusted-Firmware (TF-A).

For the example in STM32CubeMX, I create a test project, select the
STM32MP157C DK2 board and click on "generate code". Then I will find in the
test project directory the generated devicetree for kernel, TF-A and U-boot:

```
CA7/DeviceTree/test/kernel:
stm32mp157c-test-mx.dts

CA7/DeviceTree/test/tf-a:
stm32mp157c-test-mx.dts  stm32mp157c-test-mx-fw-config.dts  stm32mp15-mx.dtsi

CA7/DeviceTree/test/u-boot:
stm32mp157c-test-mx.dts  stm32mp157c-test-mx-u-boot.dtsi  stm32mp15-mx.dtsi
```

The generated devicetrees need to be copied in *BR2_EXTERNAL* tree.

```
$ cp -a ${STM32CubeMX_output}/CA7/DeviceTree/test/kernel/* ${buildroot_external}/board/stmicroelectronics/stm32mp157/kernel-dts
$ cp -a ${STM32CubeMX_output}/CA7/DeviceTree/test/u-boot/* ${buildroot_external}/board/stmicroelectronics/stm32mp157/uboot-dts
$ cp -a ${STM32CubeMX_output}/CA7/DeviceTree/test/tf-a/* ${buildroot_external}/board/stmicroelectronics/stm32mp157/tfa-dts
```

The same have been done for the *DK1*.

To use these devicetrees in Buildroot you need to change 2 things:
* The Buildroot defconfig. Update the devicetree name and the
  `BR2_*_CUSTOM_DTS_PATH` configurations, for the Kernel, U-Boot and TF-A.
```
BR2_LINUX_KERNEL_INTREE_DTS_NAME="stm32mp157c-dk2-mx"
BR2_LINUX_KERNEL_CUSTOM_DTS_PATH="$(BR2_EXTERNAL_ST_PATH)/board/stmicroelectronics/stm32mp157/linux-dts/*"
BR2_TARGET_ARM_TRUSTED_FIRMWARE_CUSTOM_DTS_PATH="$(BR2_EXTERNAL_ST_PATH)/board/stmicroelectronics/stm32mp157/tfa-dts/*
BR2_TARGET_ARM_TRUSTED_FIRMWARE_ADDITIONAL_VARIABLES="STM32MP_SDMMC=1 AARCH32_SP=optee DTB_FILE_NAME=stm32mp157c-dk2-mx.dtb BL33_CFG=$(BINARIES_DIR)/u-boot.dtb"
BR2_TARGET_UBOOT_CUSTOM_DTS_PATH="$(BR2_EXTERNAL_ST_PATH)/board/stmicroelectronics/stm32mp157/uboot-dts/*"
BR2_TARGET_UBOOT_CUSTOM_MAKEOPTS="dtb-y=stm32mp157c-dk2-mx.dtb DEVICE_TREE=stm32mp157c-dk2-mx"
```
  The option `dtb-y=stm32mp157c-dk2-mx.dtb` has been added to U-boot make
  options to build the external devicetree.

* Update the devicetree name described in the `extlinux.conf` file. This
  file is located in the overlay.

You might need to modify the post-image.sh script to use other naming of TF-A
binary. Please see the commit
_configs/st: support external devicetrees for kernel, U-boot and TF-A_
as an example of using devicetree generated by STM32CubeMX.
